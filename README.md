# ğŸ¤– NextPlot LINE Bot

![CI](https://github.com/dream30915/nextplot-linebot/actions/workflows/ci.yml/badge.svg)

NextPlot à¸„à¸·à¸­ LINE Bot à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ Laravel 12 à¹à¸¥à¸° AI à¹€à¸à¸·à¹ˆà¸­à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸šà¸£à¸´à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸œà¹ˆà¸²à¸™ LINE Messaging API

## âœ¨ à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸«à¸¥à¸±à¸

- ğŸ¤– **AI-Powered Responses** - à¹ƒà¸Šà¹‰ NLP à¹ƒà¸™à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¹à¸¥à¸°à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡
- ğŸ“Š **NextPlot Integration** - à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¸£à¸°à¸šà¸š NextPlot à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
- â˜ï¸ **Multi-Cloud Architecture** - à¸£à¸­à¸‡à¸£à¸±à¸š Google Cloud Run (Primary) à¹à¸¥à¸° Vercel (Backup)
- ğŸ’¾ **Supabase Storage** - à¸ˆà¸±à¸”à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¹„à¸Ÿà¸¥à¹Œà¸šà¸™ Supabase
- ğŸ”’ **Secure & Validated** - à¸¡à¸µà¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š LINE Signature à¹à¸¥à¸° User Allowlist

## ğŸ—ï¸ à¸ªà¸–à¸²à¸›à¸±à¸•à¸¢à¸à¸£à¸£à¸¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LINE User  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LINE Messaging API Platform     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Webhook (Primary or Backup)
       â”‚
    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚
    â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloud Run      â”‚   â”‚   Vercel     â”‚
â”‚  (Primary)      â”‚   â”‚   (Backup)   â”‚
â”‚  Laravel App    â”‚   â”‚   Serverless â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Supabase   â”‚
         â”‚   Storage    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Primary**: Google Cloud Run (2M requests/month Free Tier)  
**Backup**: Vercel (100GB bandwidth/month Free Tier)  
**Storage**: Supabase (Bucket: `nextplot`)

## ğŸš€ Quick Start

### 1. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Dependencies

```powershell
# PHP Dependencies
composer install

# Node.js Dependencies (à¸–à¹‰à¸²à¸¡à¸µ)
npm install
```

### 2. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Environment Variables

à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ `.env` à¸ˆà¸²à¸ `.env.example`:

```powershell
cp .env.example .env
```

à¹à¸à¹‰à¹„à¸‚à¸„à¹ˆà¸²à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¹ƒà¸™à¹„à¸Ÿà¸¥à¹Œ `.env`:

```env
# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN="your-channel-access-token"
LINE_CHANNEL_SECRET="your-channel-secret"
LINE_USER_ID_ALLOWLIST="user-id-1,user-id-2"

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY="your-anon-key"
SUPABASE_SERVICE_ROLE="your-service-role-key"
SUPABASE_BUCKET_NAME=nextplot
```

### 3. à¸£à¸±à¸™ Development Server

```powershell
# à¸§à¸´à¸˜à¸µ 1: à¸£à¸±à¸™ Laravel + Cloudflare Tunnel à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™
.\run-all.ps1

# à¸§à¸´à¸˜à¸µ 2: à¸£à¸±à¸™ Laravel à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
php artisan serve
```

### 4. à¸—à¸”à¸ªà¸­à¸šà¸£à¸°à¸šà¸š

```powershell
# à¸£à¸±à¸™à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¸„à¸£à¸šà¸§à¸‡à¸ˆà¸£ (8 tests)
.\test-all.ps1
```

## ğŸ“‹ à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸—à¸µà¹ˆà¸¡à¸µà¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™

| à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œ | à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢ |
|---------|----------|
| `.\test-all.ps1` | à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸—à¸¸à¸ service (8 tests) |
| `.\run-all.ps1` | à¸£à¸±à¸™ Laravel + Cloudflare Tunnel |
| `.\run-dev.ps1` | à¸£à¸±à¸™ Laravel development server |
| `.\switch-webhook.ps1` | à¸ªà¸¥à¸±à¸š LINE webhook à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ Cloud Run à¹à¸¥à¸° Vercel |
| `.\setup.ps1` | à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸ |

## ğŸ”„ à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£ Webhook

### à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸° Webhook à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™

```powershell
.\switch-webhook.ps1 -Target status
```

### à¸ªà¸¥à¸±à¸šà¹„à¸›à¹ƒà¸Šà¹‰ Cloud Run (Production)

```powershell
.\switch-webhook.ps1 -Target cloudrun
```

### à¸ªà¸¥à¸±à¸šà¹„à¸›à¹ƒà¸Šà¹‰ Vercel (Backup)

```powershell
.\switch-webhook.ps1 -Target vercel
```

## ğŸ§ª à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š

### à¸—à¸”à¸ªà¸­à¸šà¸—à¸¸à¸ Service

```powershell
.\test-all.ps1
```

à¸£à¸°à¸šà¸šà¸ˆà¸°à¸—à¸”à¸ªà¸­à¸š:

- âœ… `.env` configuration
- âœ… Laravel CLI
- âœ… Laravel HTTP server
- âœ… Supabase connection
- âœ… LINE Messaging API
- âœ… Vercel deployment
- âœ… Google Cloud Run
- âœ… Google Cloud Build

### à¸—à¸”à¸ªà¸­à¸šà¸”à¹‰à¸§à¸¢ Unit Tests

```powershell
php artisan test
```

### Static Analysis & Coding Standards

```powershell
# PHPStan (level configurable in phpstan.neon.dist)
composer phpstan

# PHP-CS-Fixer (check only)
composer php-cs-fixer

# PHP-CS-Fixer (apply fixes)
composer php-cs-fixer:fix
```

### Post-deploy Health Check

```powershell
.\u0073cripts\post-deploy-health.ps1 -Url "https://<your-cloud-run-url>/api/health" -Attempts 10 -IntervalSec 6
```

## ğŸ“¦ Deployment

### Deploy à¹„à¸› Google Cloud Run

```powershell
# Deploy à¸”à¹‰à¸§à¸¢ Cloud Build
gcloud builds submit --config cloudbuild.yaml

# à¸«à¸£à¸·à¸­ Deploy à¹‚à¸”à¸¢à¸•à¸£à¸‡
gcloud run deploy nextplot-linebot --source .
```

### Deploy à¹„à¸› Vercel

```powershell
# Deploy to Production
vercel --prod

# Preview Deployment
vercel
```

## ğŸ› ï¸ Development Workflow

### 1. Local Development

```powershell
# à¹€à¸£à¸´à¹ˆà¸¡ Laravel server
php artisan serve

# à¹€à¸£à¸´à¹ˆà¸¡ Cloudflare Tunnel (à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸”à¸ªà¸­à¸š webhook)
.\run-all.ps1
```

### 2. Testing

```powershell
# à¸£à¸±à¸™à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š
.\test-all.ps1

# à¸—à¸”à¸ªà¸­à¸š webhook à¸ˆà¸²à¸ LINE
# à¹„à¸›à¸—à¸µà¹ˆ LINE Developers Console > Webhook Settings > Test
```

### 3. Deployment

```powershell
# Push code à¸‚à¸¶à¹‰à¸™ GitHub
git add .
git commit -m "Update features"
git push

# Deploy to Cloud Run
gcloud builds submit --config cloudbuild.yaml

# Deploy to Vercel (backup)
vercel --prod
```

## ğŸ“ à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡

- [DEPLOYMENT.md](DEPLOYMENT.md) - à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸à¸²à¸£ deploy à¹à¸¥à¸° failover
- [QUICK_START.md](QUICK_START.md) - à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸§à¸”à¹€à¸£à¹‡à¸§
- [SETUP_GUIDE.md](SETUP_GUIDE.md) - à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
- [LARAVEL_SETUP.md](LARAVEL_SETUP.md) - à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Laravel
- [NEXTPLOT.md](NEXTPLOT.md) - à¹€à¸­à¸à¸ªà¸²à¸£ NextPlot API
- [Runbook: Troubleshooting & Operations](how-to-guides/runbook-line-bot-troubleshooting.md) - à¸§à¸´à¸˜à¸µà¹à¸à¹‰à¸›à¸±à¸à¸«à¸² 401/400/429, à¸à¸²à¸£à¸”à¸¹ logs à¹à¸¥à¸°à¹à¸™à¸§à¸—à¸²à¸‡ deploy

## ğŸ”§ Troubleshooting

### Webhook à¹„à¸¡à¹ˆà¸—à¸³à¸‡à¸²à¸™

```powershell
# 1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š webhook URL à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
.\switch-webhook.ps1 -Target status

# 2. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Cloud Run
.\test-all.ps1

# 3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š logs
gcloud run logs read nextplot-linebot --limit 50
```

### Supabase Connection Error

```powershell
# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š JWT keys à¹ƒà¸™ .env à¸§à¹ˆà¸²à¹„à¸¡à¹ˆà¸¡à¸µ prefix "anon:" à¸«à¸£à¸·à¸­ "service_role:"
# à¸„à¸§à¸£à¹€à¸›à¹‡à¸™: SUPABASE_ANON_KEY="eyJhbGci..."
```

### LINE Signature Validation Failed

```env
# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹ƒà¸™ .env
LINE_SIGNATURE_RELAXED="true"
```

## ğŸŒŸ Free Tier Limits

| Service | Free Tier |
|---------|-----------|
| Google Cloud Run | 2M requests/month |
| Vercel | 100GB bandwidth/month |
| Supabase | 500MB database + 1GB storage |
| Cloudflare Tunnel | Unlimited (for development) |

## ğŸ” Security

- à¹„à¸Ÿà¸¥à¹Œ `.env` à¸–à¸¹à¸à¸£à¸°à¸šà¸¸à¹ƒà¸™ `.gitignore` à¹à¸¥à¹‰à¸§ - **à¸«à¹‰à¸²à¸¡ commit à¸‚à¸¶à¹‰à¸™ Git**
- LINE Signature à¸ˆà¸°à¸–à¸¹à¸ verify à¸—à¸¸à¸ webhook request
- User Allowlist à¸ˆà¸³à¸à¸±à¸”à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰ bot à¹„à¸”à¹‰

## ğŸ“ Support

à¸«à¸²à¸à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸«à¸£à¸·à¸­à¸„à¸³à¸–à¸²à¸¡:

1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š [DEPLOYMENT.md](DEPLOYMENT.md) à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸³à¹à¸™à¸°à¸™à¸³ failover
2. à¸£à¸±à¸™ `.\test-all.ps1` à¹€à¸à¸·à¹ˆà¸­à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢à¸›à¸±à¸à¸«à¸²
3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Cloud Run logs: `gcloud run logs read nextplot-linebot`

## ğŸ“„ License

This project is built on Laravel which is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).

---

Made with â¤ï¸ using Laravel 12, LINE Messaging API, and Supabase
